

# ğŸŒ ææ‡‚ Apex API è°ƒç”¨ä¸æ¥æ”¶

æˆ‘ä»¬ä»ä¸‰ä¸ªè§’åº¦è®²ï¼š

1. **API è°ƒç”¨æ˜¯å•¥ï¼Ÿï¼ˆæ¯”å–»ï¼‰**
2. **æ€ä¹ˆå‘è¯·æ±‚ï¼ˆCalloutï¼‰ï¼Ÿ**
3. **æ€ä¹ˆæ¥æ”¶å’Œå¤„ç†å“åº”ï¼ˆResponseï¼‰ï¼Ÿ**

---

## ğŸœ ä¸€ã€API è°ƒç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

> æƒ³è±¡ Salesforce å°±åƒä¸€å®¶é¤å… ğŸ½ï¸ï¼Œ
> ä½ æ˜¯å¨æˆ¿ï¼ˆApexä»£ç ï¼‰ï¼Œ
> å¤–é¢çš„â€œAPIâ€æ˜¯é€è´§çš„è¶…å¸‚ï¼ˆå¤–éƒ¨ç³»ç»Ÿï¼‰ã€‚
>
> ä½ è¦â€œè°ƒç”¨APIâ€ï¼Œå°±æ˜¯ï¼š
>
> * å‘è¶…å¸‚ä¸‹å•ï¼ˆå‘HTTPè¯·æ±‚ Requestï¼‰
> * è¶…å¸‚å›ä½ å‘ç¥¨å’Œè´§ç‰©ï¼ˆæ”¶åˆ°HTTPå“åº” Responseï¼‰

---

## ğŸ§­ äºŒã€å‘å‡ºè¯·æ±‚ï¼ˆAPI Calloutï¼‰

åœ¨ Apex ä¸­ï¼Œå‘è¯·æ±‚è¦ç”¨åˆ°ä¸¤ä¸ªç±»ï¼š

| ç±»å             | ä½œç”¨         | æ¯”å–»        |
| -------------- | ---------- | --------- |
| `HttpRequest`  | åˆ›å»ºä¿¡ä»¶ï¼ˆå†™ä¿¡å†…å®¹ï¼‰ | å†™â€œè¦ä¹°ä»€ä¹ˆâ€çš„ä¿¡ |
| `Http`         | è´Ÿè´£å¯„ä¿¡       | æŠŠä¿¡é€å‡ºå»     |
| `HttpResponse` | æ”¶ä¿¡         | æ”¶åˆ°è¶…å¸‚çš„å›å¤   |

---

## ğŸ“¨ ä¾‹1ï¼šGET è¯·æ±‚ï¼ˆå‘å¤–éƒ¨è·å–æ•°æ®ï¼‰

### ğŸŒ° åœºæ™¯

ä½ æƒ³ä»ä¸€ä¸ªå…¬å¼€çš„å¤©æ°”APIæ‹¿åˆ°å¤©æ°”ä¿¡æ¯ã€‚

### ğŸ‘‡ ä»£ç 

```apex
// Step 1: åˆ›å»º Http å¯¹è±¡ï¼ˆé‚®å·®ï¼‰
Http http = new Http();

// Step 2: å†™ä¸€å°è¯·æ±‚ä¿¡
HttpRequest req = new HttpRequest();
req.setEndpoint('https://api.weatherapi.com/v1/current.json?key=demo&q=Tokyo'); 
req.setMethod('GET'); // è¯´æ˜æ˜¯â€œå–ä¿¡æ¯â€ï¼Œä¸æ˜¯â€œæäº¤â€

// Step 3: æŠŠä¿¡å¯„å‡ºå»ï¼Œå¾—åˆ°å›ä¿¡
HttpResponse res = http.send(req);

// Step 4: è¯»å›ä¿¡ï¼ˆAPIè¿”å›çš„JSONæ•°æ®ï¼‰
System.debug('è¿”å›çŠ¶æ€ï¼š' + res.getStatus());
System.debug('è¿”å›å†…å®¹ï¼š' + res.getBody());
```

---

### ğŸ§© è§£é‡Š

| æ¦‚å¿µ                 | å«ä¹‰                 | æ¯”å–»           |
| ------------------ | ------------------ | ------------ |
| `setEndpoint()`    | è®¾ç½®APIç½‘å€            | â€œå†™æ”¶ä»¶åœ°å€â€      |
| `setMethod('GET')` | å–æ•°æ®                | â€œå‘è¶…å¸‚æ‰“å¬ä»Šå¤©è´§ä»·â€  |
| `send()`           | å‘è¯·æ±‚                | â€œå¯„å‡ºä¿¡â€        |
| `getBody()`        | è·å–è¿”å›å†…å®¹             | â€œçœ‹å›ä¿¡å†…å®¹â€      |
| `getStatus()`      | æŸ¥çœ‹HTTPçŠ¶æ€ç ï¼ˆ200è¡¨ç¤ºæˆåŠŸï¼‰ | â€œçœ‹è¶…å¸‚æœ‰æ²¡æœ‰å›å¤æˆåŠŸâ€ |

---

## ğŸ“¦ ä¸‰ã€POST è¯·æ±‚ï¼ˆå‘é€æ•°æ®ç»™å¤–éƒ¨ç³»ç»Ÿï¼‰

> æœ‰æ—¶ä¸æ˜¯å–ä¿¡æ¯ï¼Œè€Œæ˜¯â€œä¼ ä¿¡æ¯â€ç»™å¤–éƒ¨ç³»ç»Ÿï¼Œæ¯”å¦‚ç™»è®°è®¢å•ã€‚

### ğŸŒ° åœºæ™¯

ä½ è¦æŠŠä¸€ç¬”è®¢å•å‘é€åˆ°å¤–éƒ¨ç³»ç»Ÿï¼ˆæ¯”å¦‚åˆ«çš„æœåŠ¡ï¼‰ã€‚

### ğŸ‘‡ ä»£ç 

```apex
Http http = new Http();
HttpRequest req = new HttpRequest();

// API æ¥å£
req.setEndpoint('https://example.com/api/order');
req.setMethod('POST'); // POST = æäº¤

// è®¾ç½®è¯·æ±‚å¤´ï¼ˆè¯´æ˜æ ¼å¼ï¼‰
req.setHeader('Content-Type', 'application/json');

// è¦å‘é€çš„JSONæ•°æ®
String body = '{"product":"Book","quantity":2,"price":50}';
req.setBody(body);

// å‘å‡ºè¯·æ±‚
HttpResponse res = http.send(req);

// æŸ¥çœ‹ç»“æœ
System.debug('çŠ¶æ€ç ï¼š' + res.getStatus());
System.debug('è¿”å›ç»“æœï¼š' + res.getBody());
```

---

### ğŸ§© è§£é‡Š

| æ­¥éª¤                  | ä½œç”¨                    |
| ------------------- | --------------------- |
| `setMethod('POST')` | å‘Šè¯‰å¯¹æ–¹â€œæˆ‘æœ‰æ•°æ®è¦å‘ç»™ä½ â€        |
| `setHeader()`       | å‘Šè¯‰å¯¹æ–¹æˆ‘å‘çš„æ˜¯ä»€ä¹ˆæ ¼å¼ï¼ˆé€šå¸¸æ˜¯JSONï¼‰ |
| `setBody()`         | å¡«å†™ä½ è¦ä¼ é€çš„æ•°æ®             |
| `send()`            | å‘å‡ºè¯·æ±‚                  |
| `getBody()`         | è·å–å¯¹æ–¹å›ä¼ çš„å†…å®¹ï¼ˆæ¯”å¦‚â€œè®¢å•åˆ›å»ºæˆåŠŸâ€ï¼‰ |

---

## ğŸ§  å››ã€æ¥æ”¶è¿”å›æ•°æ®ï¼ˆè§£æJSONï¼‰

> å¯¹æ–¹APIå¸¸å¸¸ç”¨ JSON æ ¼å¼å›ä½ ä¿¡æ¯ã€‚
> ä½ è¦å­¦ä¼šâ€œçœ‹æ‡‚å›ä¿¡å†…å®¹â€ã€‚

---

### ğŸŒ° ç¤ºä¾‹ï¼šè§£æJSONå“åº”

å‡è®¾è¿”å›çš„å†…å®¹æ˜¯ï¼š

```json
{
  "location": {
    "name": "Tokyo",
    "country": "Japan"
  },
  "current": {
    "temp_c": 19.5,
    "condition": { "text": "Partly cloudy" }
  }
}
```

### ğŸ‘‡ ä»£ç 

```apex
String responseBody = res.getBody();

// æŠŠJSONå˜æˆå¯ç”¨å¯¹è±¡
Map<String, Object> result = (Map<String, Object>) JSON.deserializeUntyped(responseBody);

// å–å‡ºé‡Œé¢çš„å†…å®¹
Map<String, Object> location = (Map<String, Object>) result.get('location');
Map<String, Object> current = (Map<String, Object>) result.get('current');

System.debug('åŸå¸‚ï¼š' + location.get('name'));
System.debug('æ°”æ¸©ï¼š' + current.get('temp_c'));
System.debug('å¤©æ°”ï¼š' + ((Map<String, Object>) current.get('condition')).get('text'));
```

---

### ğŸ§© è§£é‡Šï¼š

| æ–¹æ³•                          | è¯´æ˜                 |
| --------------------------- | ------------------ |
| `JSON.deserializeUntyped()` | æŠŠJSONå­—ç¬¦ä¸²è½¬æˆMapæˆ–List |
| `Map<String, Object>`       | é”®å€¼å­˜å‚¨ï¼ˆç±»ä¼¼å­—å…¸ï¼‰         |
| `get('key')`                | è·å–å¯¹åº”çš„å€¼             |

---

## ğŸ§© äº”ã€å‘½åå‡­è¯ï¼ˆNamed Credentialï¼‰

> æ¯”å–»ï¼š**â€œå…¬å¸ä¿¡å°â€**ã€‚
> å¦‚æœä½ ç»å¸¸å‘åŒä¸€ä¸ªå¤–éƒ¨APIå¯„ä¿¡ï¼Œä½ ä¸ç”¨æ¯æ¬¡éƒ½å†™ç½‘å€ã€è®¤è¯ä¿¡æ¯ã€‚
>
> Salesforce æœ‰ä¸€ä¸ªâ€œä¿¡å°æ¨¡æ¿â€å« **Named Credential**ï¼Œ
> ä½ åªè¦å†™ï¼š
>
> ```apex
> req.setEndpoint('callout:My_Named_Credential/api/data');
> ```
>
> å°±ä¼šè‡ªåŠ¨å¸®ä½ å¸¦ä¸Šè®¤è¯ä¿¡æ¯ï¼ˆæ¯”å¦‚API Keyã€ç”¨æˆ·åå¯†ç ç­‰ï¼‰ã€‚

---

## ğŸ§  å…­ã€å¸¸è§APIç±»å‹æ€»ç»“è¡¨

| ç±»å‹     | æ–¹æ³•                        | åœºæ™¯   | ç¤ºä¾‹        |
| ------ | ------------------------- | ---- | --------- |
| GET    | `req.setMethod('GET')`    | è·å–èµ„æ–™ | æŸ¥å¤©æ°”ã€æŸ¥ç”¨æˆ·ä¿¡æ¯ |
| POST   | `req.setMethod('POST')`   | æäº¤æ•°æ® | ä¸‹è®¢å•ã€æ³¨å†Œè´¦å·  |
| PUT    | `req.setMethod('PUT')`    | æ›´æ–°æ•°æ® | ä¿®æ”¹èµ„æ–™      |
| DELETE | `req.setMethod('DELETE')` | åˆ é™¤èµ„æ–™ | åˆ é™¤è´¦å·      |

---

## ğŸ§© ä¸ƒã€é”™è¯¯å¤„ç†ï¼ˆtry-catchï¼‰

API æœ‰æ—¶ä¼šå‡ºé”™ï¼ˆè¶…æ—¶ã€ç½‘å€é”™ç­‰ï¼‰ã€‚
å¿…é¡»åŠ  `try-catch` æ¥é˜²æ­¢ä»£ç å´©æºƒã€‚

### ğŸŒ° ç¤ºä¾‹

```apex
try {
    Http http = new Http();
    HttpRequest req = new HttpRequest();
    req.setEndpoint('https://api.weatherapi.com/v1/current.json?key=demo&q=Tokyo');
    req.setMethod('GET');
    HttpResponse res = http.send(req);
    System.debug(res.getBody());
} catch (System.CalloutException e) {
    System.debug('Callout å¤±è´¥ï¼š' + e.getMessage());
}
```

---

## ğŸ§© å…«ã€é™åˆ¶ä¸æ³¨æ„äº‹é¡¹

| é™åˆ¶                                            | å«ä¹‰                                     |
| --------------------------------------------- | -------------------------------------- |
| å¿…é¡»åœ¨å…è®¸Calloutçš„ç¯å¢ƒä¸­æ‰§è¡Œ                            | æ¯”å¦‚ `@future(callout=true)`ã€Queueable ç­‰ |
| æ¯ä¸ªäº‹åŠ¡æœ€å¤š 100 æ¬¡ callout                          |                                        |
| æ€»è¶…æ—¶æ—¶é—´é™åˆ¶ï¼š120 ç§’                                 |                                        |
| å¤–éƒ¨URLå¿…é¡»åœ¨ **è¿œç¨‹ç«™ç‚¹è®¾ç½®ï¼ˆRemote Site Settingsï¼‰** ä¸­æ³¨å†Œ |                                        |

---

## ğŸ¯ ä¹ã€å®Œæ•´ç¤ºä¾‹ï¼ˆå¸¦æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼‰

```apex
public class WeatherService {
    @future(callout=true)
    public static void getWeather() {
        try {
            Http http = new Http();
            HttpRequest req = new HttpRequest();
            req.setEndpoint('https://api.weatherapi.com/v1/current.json?key=demo&q=Tokyo');
            req.setMethod('GET');

            HttpResponse res = http.send(req);

            if (res.getStatusCode() == 200) {
                Map<String, Object> result = (Map<String, Object>) JSON.deserializeUntyped(res.getBody());
                Map<String, Object> current = (Map<String, Object>) result.get('current');
                System.debug('æ°”æ¸©ï¼š' + current.get('temp_c'));
            } else {
                System.debug('è¯·æ±‚å¤±è´¥ï¼š' + res.getStatus());
            }
        } catch (System.CalloutException e) {
            System.debug('é”™è¯¯ï¼š' + e.getMessage());
        }
    }
}
```

---

## âœ… åã€æ€»ç»“è¡¨æ ¼

| æ¦‚å¿µ   | Apex ç±»             | æ¯”å–»     | ä¸»è¦æ–¹æ³•                                        |
| ---- | ------------------ | ------ | ------------------------------------------- |
| åˆ›å»ºè¯·æ±‚ | `HttpRequest`      | å†™ä¿¡     | `setEndpoint()`, `setMethod()`, `setBody()` |
| å‘å‡ºè¯·æ±‚ | `Http`             | é‚®å·®     | `send()`                                    |
| å¤„ç†å“åº” | `HttpResponse`     | æ”¶ä¿¡     | `getBody()`, `getStatus()`                  |
| è§£æå†…å®¹ | `JSON` ç±»           | ç¿»è¯‘ä¿¡ä»¶   | `deserialize()`, `deserializeUntyped()`     |
| é”™è¯¯å¤„ç† | `try-catch`        | é˜²æ­¢ä¿¡ä»¶ä¸¢å¤± | `System.CalloutException`                   |
| å‘½åå‡­è¯ | `Named Credential` | å…¬å¸ä¿¡å°æ¨¡æ¿ | `callout:My_Credential`                     |

---

