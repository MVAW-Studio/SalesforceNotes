

# âš™ï¸ Apex å¼‚æ­¥å¤„ç†ï¼šApex Batch

---

## ğŸ§© ä¸€ã€Apex Batch æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ Salesforce ä¸­ï¼Œå¦‚æœä½ ä¸€æ¬¡æ€§è¦å¤„ç†æˆåƒä¸Šä¸‡æ¡è®°å½•ï¼ˆä¾‹å¦‚æ›´æ–°æ‰€æœ‰ Accountã€è®¡ç®—ç§¯åˆ†ã€å¯¼å…¥æ•°æ®ç­‰ï¼‰ï¼Œ
æ™®é€šçš„ `for` å¾ªç¯å°±ä¼šé‡åˆ° **Governor Limitï¼ˆæ²»ç†é™åˆ¶ï¼‰**ã€‚

**Apex Batch** å°±æ˜¯ Salesforce æä¾›çš„â€œåˆ†æ‰¹æ‰§è¡Œå™¨â€â€”â€”
å®ƒèƒ½æŠŠæµ·é‡æ•°æ®æ‹†åˆ†æˆå°å—åˆ†æ‰¹æ‰§è¡Œï¼Œæ¯ä¸€å—éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ï¼Œä¸ä¼šäº’ç›¸å½±å“ã€‚

---

### ğŸ§  ç”Ÿæ´»æ¯”å–»ï¼š

æƒ³è±¡ä½ è¦æ¬ä¸€æ ‹å¤§æ¥¼çš„ 10,000 ç®±è´§ã€‚

* æ™®é€š Apexï¼šä½ ä¸€ä¸ªäººè¯•å›¾ä¸€æ¬¡æ¬å®Œ ğŸ’¥ï¼ˆè¢«é™åˆ¶ï¼Œå¤±è´¥ï¼‰
* Apex Batchï¼šä½ æ´¾äº† 200 ä¸ªå·¥äººï¼Œæ¯äººæ¬ 50 ç®± âœ…ï¼ˆåˆ†æ‰¹æ‰§è¡Œï¼Œæ•ˆç‡é«˜ã€å®‰å…¨ï¼‰

---

## ğŸ§± äºŒã€Apex Batch çš„ç»“æ„ä¸æ¥å£

Apex Batch æ˜¯é€šè¿‡ **å®ç° `Database.Batchable<T>` æ¥å£** æ¥å®ç°çš„ã€‚
æ¥å£è§„å®šä½ å¿…é¡»å†™å‡º 3 ä¸ªæ–¹æ³•ï¼š

| æ–¹æ³•                                                     | ä½œç”¨            | å¿…é¡»å®ç°ï¼Ÿ |
| ------------------------------------------------------ | ------------- | ----- |
| `start(Database.BatchableContext bc)`                  | å®šä¹‰è¦å¤„ç†çš„æ•°æ®èŒƒå›´    | âœ…     |
| `execute(Database.BatchableContext bc, List<T> scope)` | å®šä¹‰æ¯æ‰¹æ¬¡å¦‚ä½•å¤„ç†æ•°æ®   | âœ…     |
| `finish(Database.BatchableContext bc)`                 | æ‰€æœ‰æ‰¹æ¬¡æ‰§è¡Œå®Œåçš„æ”¶å°¾æ“ä½œ | âœ…     |

---

## âœ… ä¸‰ã€ä»£ç ç»“æ„ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬è¦æ‰¹é‡æ›´æ–°æ‰€æœ‰ `Account`ï¼ŒæŠŠ `Active__c` å­—æ®µè®¾ä¸º `true`ã€‚

```apex
public class ActivateAccountsBatch implements Database.Batchable<SObject> {

    // 1ï¸âƒ£ startï¼šå®šä¹‰è¦å¤„ç†çš„æ•°æ®é›†
    public Database.QueryLocator start(Database.BatchableContext bc) {
        System.debug('ğŸš€ å¼€å§‹æ‰¹å¤„ç†');
        return Database.getQueryLocator([
            SELECT Id, Name, Active__c FROM Account WHERE Active__c = false
        ]);
    }

    // 2ï¸âƒ£ executeï¼šå®šä¹‰æ¯ä¸€æ‰¹çš„å¤„ç†é€»è¾‘
    public void execute(Database.BatchableContext bc, List<Account> scope) {
        System.debug('ğŸ“¦ æ­£åœ¨å¤„ç† ' + scope.size() + ' æ¡ Account');
        for (Account acc : scope) {
            acc.Active__c = true;
        }
        update scope;
    }

    // 3ï¸âƒ£ finishï¼šå®šä¹‰æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œä¹‹åçš„é€»è¾‘
    public void finish(Database.BatchableContext bc) {
        System.debug('âœ… æ‰¹å¤„ç†å…¨éƒ¨å®Œæˆ');
    }
}
```

---

### ğŸ”¹ è°ƒç”¨æ–¹å¼

åœ¨åŒ¿åçª—å£ï¼ˆDeveloper Console â†’ Execute Anonymousï¼‰ä¸­è¿è¡Œï¼š

```apex
ActivateAccountsBatch batch = new ActivateAccountsBatch();
Database.executeBatch(batch, 200); // æ¯æ‰¹å¤„ç† 200 æ¡è®°å½•
```

---

## ğŸ§  å››ã€ä¸‰ä¸ªæ–¹æ³•çš„æ‰§è¡Œæµç¨‹

| æ­¥éª¤  | æ–¹æ³•          | æè¿°                          |
| --- | ----------- | --------------------------- |
| 1ï¸âƒ£ | `start()`   | å®šä¹‰è¦å¤„ç†çš„èŒƒå›´ï¼ˆSOQL æŸ¥è¯¢æˆ– Iterableï¼‰ |
| 2ï¸âƒ£ | `execute()` | æ¯æ¬¡å¤„ç†ä¸€æ‰¹è®°å½•ï¼ˆé»˜è®¤ 200 æ¡ï¼‰          |
| 3ï¸âƒ£ | `finish()`  | å…¨éƒ¨å®Œæˆåè§¦å‘ï¼Œå¯å‘é€é€šçŸ¥æˆ–è§¦å‘å¦ä¸€ä¸ª Batch   |

---

## ğŸ’¬ äº”ã€å¸¸è§åœºæ™¯ä¸¾ä¾‹

| åœºæ™¯    | ç¤ºä¾‹           |
| ----- | ------------ |
| æ¸…ç†æ—§æ•°æ® | åˆ é™¤è¶…è¿‡ä¸€å¹´æœªæ´»è·ƒçš„è®°å½• |
| å¤§è§„æ¨¡æ›´æ–° | æ‰¹é‡è®¡ç®—ç§¯åˆ†ã€æ›´æ–°å­—æ®µ  |
| å¼‚æ­¥è°ƒç”¨  | è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿ API   |
| æ•°æ®ä¿®å¤  | æ‰¹é‡ä¿®æ”¹é”™è¯¯å­—æ®µå€¼    |

---

## ğŸ§© å…­ã€Apex Batch ä¸æ¥å£çš„å…³ç³»

åœ¨ä¸Šä¸€ç« æˆ‘ä»¬è®²è¿‡æ¥å£ï¼ˆ`interface`ï¼‰å®šä¹‰â€œè§„èŒƒâ€ã€‚
Apex Batch å°±æ˜¯ Salesforce å†…ç½®æ¥å£çš„ä¸€ç§å…¸å‹åº”ç”¨ã€‚

```apex
public class MyBatch implements Database.Batchable<SObject> {
    // å®ç°æ¥å£è¦æ±‚çš„ä¸‰ä¸ªæ–¹æ³•
    public Database.QueryLocator start(Database.BatchableContext bc) {...}
    public void execute(Database.BatchableContext bc, List<SObject> scope) {...}
    public void finish(Database.BatchableContext bc) {...}
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼š

> ğŸ§  â€œä½ å®ç°äº† Salesforce å®˜æ–¹çš„ Batchable æ¥å£ï¼Œå°±å¿…é¡»å†™å®Œè¿™ä¸‰ä¸ªæ–¹æ³•ã€‚â€

è¿™å°±æ˜¯é¢å‘å¯¹è±¡ä¸­ **â€œæ¥å£è§„å®šè¡Œä¸ºã€ç±»æä¾›å®ç°â€** çš„å…·ä½“ä½“ç°ã€‚

---

## ğŸš§ ä¸ƒã€Apex Batch çš„é™åˆ¶ï¼ˆGovernor Limitsï¼‰

| é™åˆ¶é¡¹          | è¯´æ˜                                                          |
| ------------ | ----------------------------------------------------------- |
| æ¯ä¸ªæ‰¹æ¬¡çš„æœ€å¤§æ‰§è¡Œè®°å½•æ•° | é»˜è®¤ 200ï¼Œå¯åœ¨ `Database.executeBatch(batch, size)` ä¸­è®¾ç½®ï¼Œæœ€å¤§ 2,000 |
| åŒæ—¶æ´»è·ƒçš„æ‰¹ä»»åŠ¡     | æ¯ä¸ª org æœ€å¤š 5 ä¸ªæ´»è·ƒæ‰¹å¤„ç†ä»»åŠ¡                                        |
| æœ€å¤§é˜Ÿåˆ—ç­‰å¾…æ•°      | æœ€å¤š 100 ä¸ªæŒ‚èµ·çš„æ‰¹ä»»åŠ¡                                              |
| å¼‚å¸¸æŠ›å‡º         | å¦‚æœæ‰¹æ¬¡å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–æ‰¹æ¬¡ï¼ˆäº‹åŠ¡ç‹¬ç«‹ï¼‰                                        |
| è°ƒç”¨é“¾é™åˆ¶        | Batch ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ª Batchï¼ˆéœ€åœ¨ `finish()` ä¸­è°ƒåº¦ï¼‰                   |
| DML/Query é™åˆ¶ | æ¯æ‰¹ç‹¬ç«‹è®¡ç®—æ²»ç†é™åˆ¶ï¼Œä¸ç´¯ç§¯                                              |
| æµ‹è¯•è¦†ç›–ç‡        | æµ‹è¯•ç±»å¿…é¡»è°ƒç”¨ `Database.executeBatch()` æ¥è¦†ç›–é€»è¾‘                     |

---

## âš ï¸ å…«ã€å¸¸è§æ³¨æ„äº‹é¡¹ä¸å‘

| æ³¨æ„ç‚¹                           | åŸå› ä¸è§£é‡Š                                          |
| ----------------------------- | ---------------------------------------------- |
| âŒ ä¸è¦åœ¨ `start()` ä¸­å†™å¤ªé‡é€»è¾‘        | è¿™ä¸ªé˜¶æ®µä»…ç”¨äºå®šä¹‰æ•°æ®èŒƒå›´                                  |
| âœ… DML å’Œ SOQL æ”¾åœ¨ `execute()` ä¸­ | æ¯æ‰¹ç‹¬ç«‹è¿è¡Œï¼Œå®‰å…¨ä¸è¶…é™                                   |
| âš ï¸ `scope` å¯èƒ½ä¸ºç©º               | æ‰¹æ¬¡è¢«è¿‡æ»¤æˆ–é”™è¯¯æ—¶éœ€åˆ¤ç©ºå¤„ç†                                 |
| âœ… æ‰¹æ¬¡ä¹‹é—´æ˜¯ç‹¬ç«‹äº‹åŠ¡                   | æŸä¸€æ‰¹å¤±è´¥ä¸ä¼šå½±å“å…¶ä»–æ‰¹æ¬¡                                  |
| âš ï¸ finish() ä¸­æ‰§è¡Œ DML ä»å—é™       | å®ƒæ˜¯å•ç‹¬äº‹åŠ¡ï¼Œéœ€æ§åˆ¶æ“ä½œé‡                                  |
| âœ… æ”¯æŒé“¾å¼è°ƒç”¨                      | å¯åœ¨ `finish()` è°ƒç”¨ä¸‹ä¸€ä¸ª Batch æˆ– Queueable          |
| âš ï¸ ä¸è¦ç›´æ¥ç”¨ Trigger è°ƒ Batch      | å®¹æ˜“é€ æˆå¼‚æ­¥è°ƒç”¨å åŠ ï¼Œå»ºè®®ç”¨å¼‚æ­¥æ§åˆ¶ç±»è°ƒç”¨                          |
| âš ï¸ ä¸èƒ½ç”¨ Future è°ƒ Batch         | ä¼šæŠ›å‡º â€œFuture methods cannot call batch jobsâ€ å¼‚å¸¸ |

---

## ğŸ”„ ä¹ã€è¿›é˜¶ï¼šé“¾å¼æ‰¹å¤„ç†ï¼ˆChainingï¼‰

æœ‰æ—¶ä½ éœ€è¦åœ¨ä¸€ä¸ªæ‰¹å¤„ç†å®Œæˆåæ‰§è¡Œå¦ä¸€ä¸ªæ‰¹å¤„ç†ï¼Œå¯ä»¥åœ¨ `finish()` ä¸­è°ƒç”¨ä¸‹ä¸€ä¸ªï¼š

```apex
public class FirstBatch implements Database.Batchable<SObject> {
    public Database.QueryLocator start(Database.BatchableContext bc) {
        return Database.getQueryLocator([SELECT Id FROM Account]);
    }
    public void execute(Database.BatchableContext bc, List<Account> scope) {
        System.debug('æ‰§è¡Œç¬¬ä¸€æ‰¹ä»»åŠ¡...');
    }
    public void finish(Database.BatchableContext bc) {
        System.debug('ç¬¬ä¸€æ‰¹ç»“æŸï¼Œå¯åŠ¨ä¸‹ä¸€æ‰¹');
        Database.executeBatch(new SecondBatch(), 100);
    }
}

public class SecondBatch implements Database.Batchable<SObject> {
    public Database.QueryLocator start(Database.BatchableContext bc) {
        return Database.getQueryLocator([SELECT Id FROM Contact]);
    }
    public void execute(Database.BatchableContext bc, List<Contact> scope) {
        System.debug('æ‰§è¡Œç¬¬äºŒæ‰¹ä»»åŠ¡...');
    }
    public void finish(Database.BatchableContext bc) {
        System.debug('ç¬¬äºŒæ‰¹å…¨éƒ¨å®Œæˆ âœ…');
    }
}
```

---

## ğŸ§  åã€ä¸ Queueable å’Œ Future çš„æ¯”è¾ƒ

| ç±»å‹          | æ˜¯å¦å¼‚æ­¥ | å¯å¤„ç†æ•°æ®é‡ | å¯é“¾å¼è°ƒç”¨ | æ”¯æŒè¿”å›å€¼ | åœºæ™¯          |
| ----------- | ---- | ------ | ----- | ----- | ----------- |
| `@future`   | âœ…    | å°é‡æ•°æ®   | âŒ     | âŒ     | è½»é‡ä»»åŠ¡ã€API è°ƒç”¨ |
| `Queueable` | âœ…    | ä¸­é‡æ•°æ®   | âœ…     | âœ…     | å¼‚æ­¥å¤æ‚é€»è¾‘      |
| `Batchable` | âœ…    | å¤§é‡æ•°æ®   | âœ…     | âŒ     | æµ·é‡è®°å½•å¤„ç†      |

---

## âœ… åä¸€ã€æœ€ä½³å®è·µæ€»ç»“

| å»ºè®®                                                   | åŸå›             |
| ---------------------------------------------------- | ------------- |
| âœ”ï¸ æ°¸è¿œç”¨ `Database.Stateful` ä¿æŒçŠ¶æ€                      | è·¨æ‰¹æ¬¡ä¿å­˜å˜é‡ï¼ˆå¦‚è®¡æ•°å™¨ï¼‰ |
| âœ”ï¸ åœ¨ `finish()` ä¸­å‘é‚®ä»¶æˆ–æ‰§è¡Œé“¾å¼æ‰¹å¤„ç†                         | å®ç°ä»»åŠ¡ä¸²è”        |
| âŒ ä¸è¦ç”¨ `System.abortJob()` éšæ„ä¸­æ­¢ä»»åŠ¡                     | å®¹æ˜“é€ æˆæ•°æ®ä¸ä¸€è‡´     |
| âœ”ï¸ æ—¥å¿—å’Œé”™è¯¯æ•è·è¦å¥å…¨                                        | å¦åˆ™å¤±è´¥éš¾è¿½è¸ª       |
| âœ”ï¸ ä¿æŒæ‰¹æ¬¡ç²’åº¦åˆç†ï¼ˆ200-500ï¼‰                                 | æ€§èƒ½ä¸æ²»ç†å¹³è¡¡       |
| âœ”ï¸ æµ‹è¯•ç±»åŠ¡å¿…ä½¿ç”¨ `Test.startTest()` / `Test.stopTest()` åŒ…è£¹ | è§¦å‘å¼‚æ­¥æ‰§è¡Œ        |

---

## ğŸ§© åäºŒã€Stateful ç¤ºä¾‹ï¼ˆè·¨æ‰¹æ¬¡ç»Ÿè®¡ï¼‰

```apex
public class CountAccountsBatch implements Database.Batchable<SObject>, Database.Stateful {
    public Integer totalProcessed = 0;

    public Database.QueryLocator start(Database.BatchableContext bc) {
        return Database.getQueryLocator([SELECT Id FROM Account]);
    }

    public void execute(Database.BatchableContext bc, List<Account> scope) {
        totalProcessed += scope.size();
        System.debug('æœ¬æ‰¹å¤„ç† ' + scope.size() + ' æ¡è®°å½•');
    }

    public void finish(Database.BatchableContext bc) {
        System.debug('ğŸ¯ æ€»å…±å¤„ç†äº† ' + totalProcessed + ' æ¡è®°å½•');
    }
}
```

> ğŸ”¸ åŠ ä¸Š `Database.Stateful` åï¼Œç±»ä¸­çš„æˆå‘˜å˜é‡åœ¨å¤šä¸ªæ‰¹æ¬¡ä¹‹é—´ä¼šä¿ç•™ã€‚

---

## ğŸ§¾ åä¸‰ã€æ€»ç»“ä¸€å¥è¯è®°å¿†ï¼š

| å…³é”®è¯                | è®°å¿†å£è¯€                             |
| ------------------ | -------------------------------- |
| **Batchable æ¥å£**   | â€œæˆ‘è§„å®š 3 ä»¶äº‹ï¼šstartã€executeã€finishã€‚â€ |
| **Governor Limit** | â€œæ¯æ‰¹å•ç‹¬ç®—é™é¢ï¼Œäº’ä¸å½±å“ã€‚â€                  |
| **Stateful**       | â€œæˆ‘è®°å¾—æˆ‘åšäº†å¤šå°‘ã€‚â€                      |
| **Chaining**       | â€œåšå®Œä¸€ä»¶äº‹ï¼Œæ¥ç€åšä¸‹ä¸€ä»¶ã€‚â€                  |
| **é€‚ç”¨åœºæ™¯**           | â€œå½“ä½ è¦å¤„ç†è¶…è¿‡ 10,000 æ¡è®°å½•æ—¶ï¼Œç”¨ Batchã€‚â€   |


